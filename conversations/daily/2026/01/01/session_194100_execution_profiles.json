{
  "date": "2026-01-01",
  "title": "Execution Profiles 스펙 - Spot/Futures/Scalping 분리",
  "version": "1.0.0",
  "status": "DRAFT - 검토 필요",

  "critical_issues": {
    "issue_1_cost_vs_tp": {
      "severity": "CRITICAL",
      "problem": "비용 0.8% (왕복) vs TP 0.5% = 구조적 손실",
      "current": {
        "fee_bps": 10.0,
        "slippage_bps": 30.0,
        "total_one_way": "0.4%",
        "total_round_trip": "0.8%",
        "scalping_tp1": "0.5%",
        "scalping_tp2": "0.5%"
      },
      "solution": "TP를 ATR 기반으로 변경 또는 비용 가정 현실화",
      "fix_location": [
        "src/wpcn/_03_common/_03_wyckoff/events.py:216-218 (tp1_mult, tp2_mult)",
        "src/wpcn/_01_crypto/001_binance/001_spot/001_backtest/main.py:67"
      ]
    },

    "issue_2_gate_too_loose": {
      "severity": "HIGH",
      "problem": "conf_min 0.50, edge_min 0.60 = 쓰레기 신호 허용",
      "current": {
        "conf_min": 0.50,
        "edge_min": 0.60
      },
      "recommended": {
        "conf_min": 0.65,
        "edge_min": 0.70,
        "note": "Unknown/No-trade 비율 30% 이상 목표"
      },
      "fix_location": [
        "src/wpcn/_03_common/_01_core/types.py:19-20",
        "src/wpcn/_00_config/backtest.py:27-28"
      ]
    },

    "issue_3_spot_short_impossible": {
      "severity": "HIGH",
      "problem": "현물에서 short 비율 30%는 실행 불가",
      "current": {
        "accumulation": {"long": 0.70, "short": 0.30},
        "distribution": {"long": 0.30, "short": 0.70}
      },
      "solution": "Spot용 DIRECTION_RATIOS 별도 정의 (short → cash)",
      "fix_location": "src/wpcn/_03_common/_03_wyckoff/phases.py:83-88"
    },

    "issue_4_confirm_too_fast": {
      "severity": "MEDIUM",
      "problem": "confirm_bars=1 + N_reclaim=3 = 휩쏘 취약",
      "current": {
        "confirm_bars": 1,
        "N_reclaim": 3
      },
      "recommended": {
        "confirm_bars": 2,
        "N_reclaim": 3,
        "reclaim_hold_bars": 2,
        "note": "reclaim 후 박스 내부 유지 확인 필요"
      },
      "fix_location": "src/wpcn/_03_common/_01_core/types.py:21"
    },

    "issue_5_f_min_undefined": {
      "severity": "LOW",
      "problem": "F_min=0.70의 정의가 불명확",
      "current": {
        "F_min": 0.70,
        "comment_in_code": "execution realism knobs"
      },
      "clarification_needed": {
        "meaning": "fill probability (주문 체결 확률)",
        "range": "0.0 ~ 1.0",
        "usage": "pending_orders 처리 시 확률적 체결 시뮬레이션",
        "calculation": "TODO: 정의 필요"
      },
      "fix_location": "src/wpcn/_03_common/_01_core/types.py:41"
    },

    "issue_6_max_hold_mismatch": {
      "severity": "MEDIUM",
      "problem": "max_hold_bars=30 (7.5시간) vs Wyckoff Phase (하루~며칠)",
      "current": {
        "max_hold_bars": 30,
        "timeframe": "15m",
        "hold_hours": 7.5
      },
      "solution": "Scalping과 Navigation 모드 분리",
      "recommended": {
        "scalping_max_hold": 30,
        "navigation_max_hold": 192,
        "navigation_hold_hours": 48
      }
    }
  },

  "execution_profiles": {
    "spot_navigation": {
      "description": "현물 와이코프 네비게이션 모드",
      "timeframe": "15m",
      "signals": ["spring", "utad"],
      "direction_ratios": {
        "accumulation": {"long_exposure": 0.70, "cash_exposure": 0.30},
        "distribution": {"long_exposure": 0.30, "cash_exposure": 0.70},
        "re_accumulation": {"long_exposure": 0.80, "cash_exposure": 0.20},
        "re_distribution": {"long_exposure": 0.20, "cash_exposure": 0.80},
        "unknown": {"long_exposure": 0.50, "cash_exposure": 0.50}
      },
      "costs": {
        "fee_bps": 10.0,
        "slippage_bps": 15.0,
        "note": "Maker 수수료 + 현실적 슬리피지"
      },
      "exits": {
        "tp1_method": "box_mid (박스 중간)",
        "tp2_method": "box_high (박스 상단)",
        "stop_method": "box_low - atr_mult * ATR",
        "max_hold_bars": 192,
        "note": "15m * 192 = 48시간"
      },
      "gates": {
        "conf_min": 0.65,
        "edge_min": 0.70,
        "confirm_bars": 2,
        "reclaim_hold_bars": 2,
        "chaos_filter": true
      }
    },

    "spot_scalping": {
      "description": "현물 단타 모드 (RSI 다이버전스, 피보나치)",
      "timeframe": "15m",
      "signals": ["rsi_div_long", "fib_bounce_long", "stoch_cross_long"],
      "direction": "long_only",
      "costs": {
        "fee_bps": 7.5,
        "slippage_bps": 10.0,
        "note": "BNB 할인 + 지정가 주문 가정"
      },
      "exits": {
        "tp1_method": "atr_mult (동적)",
        "tp2_method": "atr_mult + 0.4",
        "stop_method": "low - atr_mult * ATR",
        "max_hold_bars": 30,
        "min_rr_ratio": 1.5,
        "note": "TP/비용 > 1.5 필수"
      },
      "atr_multipliers": {
        "extreme_volatility": {"stop": 0.3, "tp1": 0.6, "tp2": 1.0},
        "high_volatility": {"stop": 0.4, "tp1": 0.8, "tp2": 1.5},
        "medium_volatility": {"stop": 0.5, "tp1": 1.0, "tp2": 1.8},
        "low_volatility": {"stop": 0.6, "tp1": 1.2, "tp2": 2.0}
      },
      "gates": {
        "conf_min": 0.60,
        "edge_min": 0.65,
        "confirm_bars": 1,
        "chaos_filter": true
      }
    },

    "futures_navigation": {
      "description": "선물 와이코프 네비게이션 모드",
      "timeframe": "15m",
      "signals": ["spring", "utad"],
      "direction_ratios": {
        "accumulation": {"long": 0.70, "short": 0.30},
        "distribution": {"long": 0.30, "short": 0.70},
        "re_accumulation": {"long": 0.80, "short": 0.20},
        "re_distribution": {"long": 0.20, "short": 0.80},
        "unknown": {"long": 0.50, "short": 0.50}
      },
      "leverage": {
        "max_leverage": 5,
        "position_size_pct": 0.20,
        "note": "5배 레버리지 * 20% 포지션 = 실질 1배"
      },
      "costs": {
        "fee_bps": 4.0,
        "slippage_bps": 15.0,
        "funding_rate_assumption": 0.01,
        "note": "Maker 수수료 + 펀딩비 고려"
      },
      "exits": {
        "tp1_method": "box_mid",
        "tp2_method": "box_opposite",
        "stop_method": "box_edge - atr_mult * ATR",
        "max_hold_bars": 192,
        "liquidation_buffer_pct": 0.50
      },
      "gates": {
        "conf_min": 0.65,
        "edge_min": 0.70,
        "confirm_bars": 2,
        "reclaim_hold_bars": 2,
        "chaos_filter": true
      }
    },

    "futures_scalping": {
      "description": "선물 단타 모드",
      "timeframe": "15m",
      "signals": ["rsi_div_long", "rsi_div_short", "fib_bounce_long", "fib_bounce_short"],
      "direction": "both",
      "leverage": {
        "max_leverage": 3,
        "position_size_pct": 0.10,
        "note": "3배 레버리지 * 10% = 실질 0.3배"
      },
      "costs": {
        "fee_bps": 4.0,
        "slippage_bps": 10.0
      },
      "exits": {
        "tp1_method": "atr_mult",
        "tp2_method": "atr_mult + 0.4",
        "stop_method": "atr_mult",
        "max_hold_bars": 30
      },
      "gates": {
        "conf_min": 0.60,
        "edge_min": 0.65,
        "confirm_bars": 1,
        "chaos_filter": true
      }
    }
  },

  "parameter_definitions": {
    "theta": {
      "pivot_lr": {
        "type": "int",
        "default": 4,
        "range": [2, 10],
        "description": "피벗 좌우 바 수 (스윙 감지용)"
      },
      "box_L": {
        "type": "int",
        "default": 96,
        "range": [48, 192],
        "description": "박스 길이 (15m * 96 = 24시간)"
      },
      "m_freeze": {
        "type": "int",
        "default": 32,
        "range": [16, 64],
        "description": "박스 프리즈 기간 (박스 확정 후 유지)"
      },
      "atr_len": {
        "type": "int",
        "default": 14,
        "range": [10, 20],
        "description": "ATR 계산 기간"
      },
      "x_atr": {
        "type": "float",
        "default": 0.35,
        "range": [0.2, 0.5],
        "description": "돌파 임계값 (ATR 배수)"
      },
      "m_bw": {
        "type": "float",
        "default": 0.10,
        "range": [0.05, 0.20],
        "description": "박스폭 비율 (reclaim 레벨)"
      },
      "N_reclaim": {
        "type": "int",
        "default": 3,
        "range": [2, 5],
        "description": "reclaim 허용 기간 (봉 수)"
      },
      "N_fill": {
        "type": "int",
        "default": 5,
        "range": [3, 10],
        "description": "주문 체결 허용 기간"
      },
      "F_min": {
        "type": "float",
        "default": 0.70,
        "range": [0.5, 0.9],
        "description": "최소 체결 확률 (pending order 필터)",
        "calculation": "volume_ratio * price_proximity",
        "note": "pending order가 F_min 미만이면 취소"
      }
    },

    "backtest_config": {
      "initial_equity": {
        "type": "float",
        "default": 1.0,
        "description": "초기 자본 (정규화용)"
      },
      "max_hold_bars": {
        "type": "int",
        "default": 30,
        "range": [20, 200],
        "description": "최대 보유 기간",
        "by_mode": {
          "scalping": 30,
          "navigation": 192
        }
      },
      "tp1_frac": {
        "type": "float",
        "default": 0.5,
        "range": [0.3, 0.7],
        "description": "TP1 청산 비율"
      },
      "conf_min": {
        "type": "float",
        "default": 0.65,
        "range": [0.55, 0.80],
        "description": "최소 신뢰도 (top1 확률)"
      },
      "edge_min": {
        "type": "float",
        "default": 0.70,
        "range": [0.60, 0.85],
        "description": "최소 엣지 스코어"
      },
      "confirm_bars": {
        "type": "int",
        "default": 2,
        "range": [1, 3],
        "description": "신호 확정 대기 봉 수"
      },
      "chaos_ret_atr": {
        "type": "float",
        "default": 3.0,
        "range": [2.0, 4.0],
        "description": "CHAOS 레짐 판정 임계값"
      }
    }
  },

  "cost_reality_check": {
    "binance_spot": {
      "maker_fee": "0.10% (BNB: 0.075%)",
      "taker_fee": "0.10% (BNB: 0.075%)",
      "realistic_slippage": {
        "BTC": "0.01-0.03%",
        "ETH": "0.02-0.05%",
        "altcoins": "0.05-0.15%"
      },
      "recommended_total": {
        "BTC_maker": "0.10% + 0.02% = 0.12%",
        "BTC_taker": "0.10% + 0.03% = 0.13%",
        "altcoin_taker": "0.10% + 0.10% = 0.20%"
      }
    },
    "binance_futures": {
      "maker_fee": "0.02%",
      "taker_fee": "0.04%",
      "funding_rate": "평균 0.01% (8시간)",
      "realistic_slippage": "0.02-0.05%",
      "recommended_total": {
        "maker": "0.02% + 0.03% = 0.05%",
        "taker": "0.04% + 0.05% = 0.09%"
      }
    },
    "conclusion": "현재 설정 0.4% (편도)는 과도하게 보수적. Spot BTC는 0.12-0.15%, Futures는 0.05-0.10%가 현실적"
  },

  "next_actions": [
    {
      "priority": 1,
      "action": "BacktestCosts 수정",
      "file": "types.py, main.py",
      "changes": {
        "spot_btc": {"fee_bps": 7.5, "slippage_bps": 3.0},
        "spot_alt": {"fee_bps": 10.0, "slippage_bps": 10.0},
        "futures": {"fee_bps": 4.0, "slippage_bps": 5.0}
      }
    },
    {
      "priority": 2,
      "action": "conf_min/edge_min 상향",
      "file": "types.py, backtest.py",
      "changes": {"conf_min": 0.65, "edge_min": 0.70}
    },
    {
      "priority": 3,
      "action": "DIRECTION_RATIOS_SPOT 추가",
      "file": "phases.py",
      "changes": "short → cash_exposure로 재정의"
    },
    {
      "priority": 4,
      "action": "confirm_bars 상향 + reclaim_hold 추가",
      "file": "types.py, events.py",
      "changes": {"confirm_bars": 2, "reclaim_hold_bars": 2}
    },
    {
      "priority": 5,
      "action": "F_min 정의 문서화",
      "file": "types.py 주석 추가",
      "note": "fill probability 계산식 명시"
    }
  ]
}
