{
  "title": "_08_tuning 모듈 개선 통합 계획",
  "created_at": "2026-01-01",
  "updated_at": "2026-01-01",
  "status": "Phase 0-2 완료 및 검증 완료, Phase 3 대기",
  "summary": "파라미터 타임프레임 불일치, futures 경로 하드코딩, 랜덤 stub 백테스트 문제 해결",

  "verification": {
    "verified_at": "2026-01-01",
    "all_tests_passed": true,
    "fixes_applied": [
      "cycle_analyzer.py: from __future__ syntax error fixed (duplicate docstring merged)"
    ],
    "phase_0_results": {
      "status": "PASS",
      "0-1": "scheduler.py: market/timeframe params added, data_path = bronze/binance/{market}/{symbol}/{tf}",
      "0-2": "scheduler.py: UserWarning for STUB backtest added"
    },
    "phase_1_results": {
      "status": "PASS",
      "1-1": "param_schema.py: TUNABLE_PARAMS_MINUTES(7), TUNABLE_PARAMS_RATIO(6), FIXED_PARAMS(8), EXECUTION_PARAMS(2)",
      "1-2": "param_schema.py: minutes_to_bars, bars_to_minutes, convert_params_to_bars working",
      "1-3": "param_store.py: SCHEMA_VERSION=2, ParamConfidence, ParamPerformance, load_reliable()"
    },
    "phase_2_results": {
      "status": "PASS",
      "2-1": "weekly_optimizer.py moved to scalping/ folder (5m scalping dedicated)",
      "2-2": "walk_forward.py = 15m official optimizer (WalkForwardOptimizer, V8_PARAM_SPACE)",
      "2-3": "__init__.py exports 41 v2 APIs"
    },
    "import_tests": [
      "wpcn._08_tuning core imports: PASS",
      "wpcn._08_tuning.scalping imports: PASS",
      "wpcn._08_tuning.scheduler imports: PASS",
      "wpcn._08_tuning.cycle_analyzer imports: PASS (after fix)"
    ]
  },

  "problems": {
    "critical": [
      {
        "id": "P1",
        "description": "scheduler.py가 futures 경로 하드코딩",
        "file": "scheduler.py:194",
        "detail": "data_path = .../bronze/binance/futures/{symbol}/5m → spot 데이터가 아닌 futures 읽음",
        "impact": "매주 배치가 잘못된 데이터로 최적화"
      },
      {
        "id": "P2",
        "description": "백테스트가 랜덤 stub",
        "file": "scheduler.py:225-243",
        "detail": "_create_backtest_func()이 np.random으로 결과 생성",
        "impact": "최적화 결과가 완전히 무의미"
      },
      {
        "id": "P3",
        "description": "타임프레임 단위 불일치",
        "files": ["weekly_optimizer.py", "walk_forward.py"],
        "detail": {
          "weekly_optimizer": "box_L: [30,50,70,100], cooldown_bars=24 (5m 기준)",
          "walk_forward": "box_L: (48,192) (15m 기준)"
        },
        "impact": "같은 파라미터 이름인데 단위가 다름 → 섞어 쓰면 재앙"
      }
    ],
    "important": [
      {
        "id": "P4",
        "description": "파라미터 스키마 미정의",
        "detail": "TUNABLE vs FIXED 구분 없음, 단위 명시 없음"
      },
      {
        "id": "P5",
        "description": "main.py ParamStore 미연동",
        "detail": "DEFAULT_THETA 하드코딩, 동적 파라미터 로드 안 함"
      }
    ]
  },

  "solution": {
    "core_principle": "시간(분) 단위로 저장, 런타임에 bars로 변환",
    "benefits": [
      "5m/15m/1h 어떤 타임프레임이든 동일한 의미",
      "저장/비교/버전관리가 일관됨",
      "human-readable"
    ]
  },

  "phases": [
    {
      "phase": 0,
      "name": "긴급 수정",
      "priority": "CRITICAL",
      "reason": "지금 안 하면 매주 자동으로 잘못된 데이터로 랜덤 최적화",
      "tasks": [
        {
          "id": "0-1",
          "file": "scheduler.py",
          "description": "futures → spot 경로 수정",
          "changes": [
            "market 파라미터 추가 (spot/futures)",
            "timeframe 파라미터 추가",
            "_load_data() 경로를 .../bronze/binance/{market}/{symbol}/{tf}로 수정"
          ]
        },
        {
          "id": "0-2",
          "file": "scheduler.py",
          "description": "랜덤 stub 제거 → 실제 백테스트 엔진 연결",
          "changes": [
            "_create_backtest_func()에서 실제 백테스트 엔진 호출",
            "또는 TODO 주석으로 명확히 표시"
          ]
        }
      ]
    },
    {
      "phase": 1,
      "name": "파라미터 스키마 통일",
      "priority": "HIGH",
      "tasks": [
        {
          "id": "1-1",
          "file": "param_schema.py (신규)",
          "description": "파라미터 스키마 정의",
          "content": {
            "TUNABLE_PARAMS_MINUTES": {
              "box_window_minutes": [720, 2880],
              "freeze_minutes": [120, 480],
              "pivot_window_minutes": [30, 120],
              "cooldown_minutes": [60, 240],
              "max_hold_minutes": [720, 2880]
            },
            "TUNABLE_PARAMS_RATIO": {
              "x_atr": [0.2, 0.5],
              "m_bw": [0.05, 0.15],
              "tp_pct": [0.01, 0.03],
              "sl_pct": [0.005, 0.015],
              "min_score": [3.0, 6.0]
            },
            "FIXED_PARAMS": {
              "N_fill": 3,
              "F_min": 0.3,
              "conf_min": 0.65,
              "edge_min": 0.70,
              "confirm_bars": 2,
              "reclaim_hold_bars": 2,
              "atr_len": 14
            }
          }
        },
        {
          "id": "1-2",
          "file": "param_schema.py",
          "description": "변환 유틸 함수",
          "functions": [
            "minutes_to_bars(minutes, timeframe) -> int",
            "bars_to_minutes(bars, timeframe) -> int"
          ]
        },
        {
          "id": "1-3",
          "file": "param_store.py",
          "description": "v2 저장 포맷 지원",
          "changes": [
            "schema_version 필드 추가",
            "market, timeframe, unit 필드 강제",
            "legacy 파일 로드 시 변환"
          ]
        }
      ]
    },
    {
      "phase": 2,
      "name": "최적화 모듈 역할 확정",
      "priority": "MEDIUM",
      "tasks": [
        {
          "id": "2-1",
          "file": "weekly_optimizer.py",
          "description": "5m 스캘핑 전용으로 분리",
          "options": [
            "scalping/ 폴더로 이동",
            "또는 legacy/로 이동 (폐기)"
          ]
        },
        {
          "id": "2-2",
          "file": "walk_forward.py",
          "description": "15m 네비게이션 공식 최적화기로 확정",
          "changes": [
            "V8_PARAM_SPACE를 분 단위로 변경",
            "또는 param_schema.py 참조"
          ]
        },
        {
          "id": "2-3",
          "file": "__init__.py",
          "description": "공식 API 정리"
        }
      ]
    },
    {
      "phase": 3,
      "name": "파이프라인 연결",
      "priority": "MEDIUM",
      "tasks": [
        {
          "id": "3-1",
          "file": "run_tuning.py",
          "description": "cycle_analyzer → adaptive_space → walk_forward 연결"
        },
        {
          "id": "3-2",
          "file": "main.py",
          "description": "ParamStore에서 동적 파라미터 로드",
          "changes": [
            "시작 시 ParamStore.load() 호출",
            "신뢰도 기반 fallback 로직"
          ]
        },
        {
          "id": "3-3",
          "file": "param_store.py",
          "description": "신뢰도 기반 파라미터 선택 로직",
          "logic": "confidence_score >= 60이면 적용, 아니면 이전 주 또는 DEFAULT"
        }
      ]
    }
  ],

  "storage_format_v2": {
    "schema_version": 2,
    "market": "spot",
    "symbol": "BTC-USDT",
    "timeframe": "15m",
    "unit": "minutes",
    "created_at": "2026-01-05T00:00:00",
    "params": {
      "box_window_minutes": 1440,
      "freeze_minutes": 360,
      "cooldown_minutes": 120,
      "tp_pct": 0.015,
      "sl_pct": 0.008,
      "min_score": 4.5
    },
    "performance": {
      "train": {"return": 12.5, "sharpe": 1.8, "mdd": -5.2},
      "val": {"return": 8.3, "sharpe": 1.4, "mdd": -4.1},
      "oos": null
    },
    "confidence": {
      "overfit_ratio": 0.66,
      "cv_consistency": 0.85,
      "confidence_score": 72.5
    }
  },

  "final_folder_structure": {
    "_08_tuning/": {
      "__init__.py": "공식 API exports",
      "param_schema.py": "[신규] 파라미터 스키마 + 변환 유틸",
      "param_store.py": "[수정] v2 포맷 지원",
      "param_optimizer.py": "Bayesian/Random/Grid",
      "walk_forward.py": "[공식] 15m 네비게이션 최적화기",
      "adaptive_space.py": "사이클 기반 탐색 공간",
      "cycle_analyzer.py": "FFT 사이클 분석",
      "scheduler.py": "[수정] spot 경로 + 실제 백테스트",
      "run_tuning.py": "통합 파이프라인",
      "scalping/": {
        "weekly_optimizer.py": "5m 스캘핑 전용 (분리)"
      },
      "legacy/": {
        "analyze_wyckoff_cycles.py": "폐기",
        "analyze_wyckoff_cycles_gpt_patched.py": "폐기"
      }
    }
  }
}
