{
  "title": "_08_tuning 모듈 리팩토링 완료 보고서",
  "created_at": "2026-01-01",
  "status": "Phase 0-2 완료",

  "summary": {
    "description": "파라미터 타임프레임 불일치, futures 경로 하드코딩, 랜덤 stub 백테스트 문제 해결",
    "core_changes": [
      "시간 파라미터를 '분(minutes)' 단위로 통일, 런타임에 bars로 변환",
      "scheduler.py의 futures 하드코딩 → spot/futures 선택 가능",
      "param_store.py v2 포맷 (신뢰도 점수 지원)",
      "weekly_optimizer.py를 scalping/ 폴더로 분리 (5m 전용)"
    ]
  },

  "completed_tasks": {
    "phase_0": {
      "name": "긴급 수정",
      "status": "completed",
      "tasks": [
        {
          "id": "0-1",
          "description": "scheduler.py futures→spot 경로 수정",
          "file": "scheduler.py",
          "changes": [
            "market 파라미터 추가 (spot/futures 선택)",
            "timeframe 파라미터 추가 (5m/15m/1h/4h/1d)",
            "_load_data() 경로를 동적으로 변경: .../bronze/binance/{market}/{symbol}/{timeframe}/",
            "CLI 옵션 추가: --market, --timeframe"
          ]
        },
        {
          "id": "0-2",
          "description": "scheduler.py 랜덤 stub 경고 추가",
          "file": "scheduler.py",
          "changes": [
            "_create_backtest_func()에 UserWarning 추가",
            "TODO 주석으로 실제 구현 필요 명시",
            "docstring에 STUB 상태 경고 추가"
          ]
        }
      ]
    },
    "phase_1": {
      "name": "파라미터 스키마 통일",
      "status": "completed",
      "tasks": [
        {
          "id": "1-1",
          "description": "param_schema.py 신규 생성",
          "file": "param_schema.py (NEW)",
          "exports": [
            "TUNABLE_PARAMS_MINUTES - 시간 기반 튜닝 파라미터 (분 단위)",
            "TUNABLE_PARAMS_RATIO - 비율 기반 튜닝 파라미터",
            "FIXED_PARAMS - 고정 파라미터 (튜닝 금지)",
            "TF_MINUTES - 타임프레임별 분 단위 매핑",
            "minutes_to_bars() - 분 → 봉 변환",
            "bars_to_minutes() - 봉 → 분 변환",
            "convert_params_to_bars() - 전체 파라미터 변환",
            "convert_params_to_minutes() - 역변환 (저장용)",
            "validate_tunable_params() - 범위 검증",
            "DefaultParams - 기본값 클래스",
            "DEFAULT_PARAMS - 기본 인스턴스"
          ]
        },
        {
          "id": "1-2",
          "description": "param_store.py v2 포맷 지원",
          "file": "param_store.py",
          "changes": [
            "SCHEMA_VERSION = 2 상수 추가",
            "ParamConfidence 클래스 추가 (신뢰도 지표)",
            "ParamPerformance 클래스 추가 (성능 지표 구조화)",
            "OptimizedParams에 v2 필드 추가 (schema_version, market, unit, confidence, performance)",
            "ParamStore에 market 파라미터 추가",
            "load_reliable() 메서드 추가 (신뢰도 기반 파라미터 선택)",
            "v1 레거시 포맷 호환 유지"
          ]
        }
      ]
    },
    "phase_2": {
      "name": "최적화 모듈 역할 분리",
      "status": "completed",
      "tasks": [
        {
          "id": "2-1",
          "description": "weekly_optimizer.py scalping 폴더로 분리",
          "changes": [
            "scalping/ 폴더 생성",
            "weekly_optimizer.py → scalping/weekly_optimizer.py 이동",
            "scalping/__init__.py 생성 (5m 스캘핑 전용 명시)",
            "scheduler.py import 경로 수정"
          ]
        },
        {
          "id": "2-2",
          "description": "__init__.py 공식 API 정리",
          "file": "__init__.py",
          "changes": [
            "v2 docstring 업데이트",
            "param_schema.py exports 추가",
            "param_store.py v2 클래스 exports 추가 (ParamConfidence, ParamPerformance, SCHEMA_VERSION)",
            "__all__ 목록 재정리"
          ]
        }
      ]
    }
  },

  "pending_tasks": {
    "phase_3": {
      "name": "파이프라인 연결",
      "status": "pending",
      "tasks": [
        {
          "id": "3-1",
          "description": "main.py ParamStore 연동",
          "file": "main.py",
          "required_changes": [
            "시작 시 ParamStore.load_reliable() 호출",
            "DEFAULT_THETA 대신 동적 파라미터 사용",
            "신뢰도 낮으면 기본값 fallback"
          ]
        },
        {
          "id": "3-2",
          "description": "scheduler.py 실제 백테스트 연결",
          "file": "scheduler.py",
          "required_changes": [
            "_create_backtest_func()에서 broker_sim.simulate() 호출",
            "params → Theta/BacktestConfig 변환 로직 구현"
          ]
        }
      ]
    }
  },

  "folder_structure": {
    "_08_tuning/": {
      "__init__.py": "v2 API exports",
      "param_schema.py": "[NEW] 파라미터 스키마 + 단위 변환",
      "param_store.py": "[MODIFIED] v2 포맷, 신뢰도 지원",
      "param_optimizer.py": "Bayesian/Random/Grid",
      "walk_forward.py": "15m 네비게이션 공식 최적화기",
      "adaptive_space.py": "사이클 기반 탐색 공간",
      "cycle_analyzer.py": "FFT 사이클 분석",
      "scheduler.py": "[MODIFIED] spot/futures 선택, 경고 추가",
      "run_tuning.py": "통합 파이프라인",
      "theta_space.py": "Theta 파라미터 공간",
      "weekly_batch.py": "주간 배치",
      "scalping/": {
        "__init__.py": "[NEW] 5m 스캘핑 전용 설명",
        "weekly_optimizer.py": "[MOVED] 5m 스캘핑 전용"
      },
      "legacy/": {
        "__init__.py": "폐기된 코드 설명",
        "analyze_wyckoff_cycles.py": "원본 (deprecated)",
        "analyze_wyckoff_cycles_gpt_patched.py": "GPT 패치 (deprecated)"
      }
    }
  },

  "new_features": {
    "param_schema": {
      "description": "파라미터 단위 통일 시스템",
      "usage_example": {
        "code": [
          "from wpcn._08_tuning import minutes_to_bars, convert_params_to_bars",
          "",
          "# 분 → 봉 변환",
          "box_L = minutes_to_bars(1440, '15m')  # 1440분 → 96봉",
          "",
          "# 전체 파라미터 변환",
          "params_minutes = {'box_window_minutes': 1440, 'freeze_minutes': 360}",
          "params_bars = convert_params_to_bars(params_minutes, '15m')",
          "# → {'box_L': 96, 'm_freeze': 24}"
        ]
      }
    },
    "load_reliable": {
      "description": "신뢰도 기반 파라미터 로드",
      "usage_example": {
        "code": [
          "from wpcn._08_tuning import get_param_store, DEFAULT_PARAMS",
          "",
          "store = get_param_store(market='spot')",
          "params = store.load_reliable(",
          "    symbol='BTC-USDT',",
          "    timeframe='15m',",
          "    min_confidence=60.0,",
          "    default_params=DEFAULT_PARAMS.to_dict()",
          ")"
        ]
      }
    },
    "scheduler_cli": {
      "description": "마켓/타임프레임 선택 가능한 스케줄러",
      "usage_example": {
        "commands": [
          "python -m wpcn._08_tuning.scheduler --run-now --market spot --timeframe 15m",
          "python -m wpcn._08_tuning.scheduler --check-sunday --symbols BTC-USDT ETH-USDT"
        ]
      }
    }
  },

  "storage_format_v2": {
    "schema_version": 2,
    "market": "spot",
    "symbol": "BTC-USDT",
    "timeframe": "15m",
    "unit": "minutes",
    "created_at": "2026-01-05T00:00:00",
    "params": {
      "box_window_minutes": 1440,
      "freeze_minutes": 360,
      "cooldown_minutes": 120,
      "tp_pct": 0.015,
      "sl_pct": 0.008,
      "min_score": 4.5
    },
    "confidence": {
      "overfit_ratio": 0.85,
      "cv_consistency": 0.72,
      "temporal_stability": 0.68,
      "oos_performance": null,
      "confidence_score": 68.5
    },
    "performance": {
      "train": {"return": 12.5, "sharpe": 1.8, "mdd": -5.2},
      "val": {"return": 8.3, "sharpe": 1.4, "mdd": -4.1},
      "oos": null
    }
  },

  "key_constants": {
    "TUNABLE_PARAMS_MINUTES": {
      "box_window_minutes": [720, 2880],
      "freeze_minutes": [120, 480],
      "pivot_window_minutes": [30, 120],
      "cooldown_minutes": [60, 240],
      "max_hold_minutes": [720, 2880]
    },
    "TUNABLE_PARAMS_RATIO": {
      "x_atr": [0.2, 0.5],
      "m_bw": [0.05, 0.15],
      "tp_pct": [0.01, 0.03],
      "sl_pct": [0.005, 0.015],
      "min_score": [3.0, 6.0]
    },
    "FIXED_PARAMS": {
      "conf_min": 0.65,
      "edge_min": 0.70,
      "confirm_bars": 2,
      "reclaim_hold_bars": 2,
      "atr_len": 14,
      "N_fill": 3,
      "F_min": 0.3
    }
  }
}
